<ion-content class="call-container" [ngClass]="{'connecting': isConnecting, 'connected': isConnected, 'incoming': hasIncomingCall}">
  <!-- Call Header -->
  <div class="call-header">
    <div class="client-info">
      <ion-avatar class="client-avatar">
        <img [src]="clientAvatar" 
             [alt]="clientName + ' avatar'" 
             (error)="onImageError($event)">
      </ion-avatar>
      <div class="call-details">
        <h2>{{ clientName }}</h2>
        <p class="call-status" [ngClass]="callState" aria-live="polite">{{ callStateText }}</p>
      </div>
    </div>
    
    <!-- Call Timer -->
    <div class="call-timer" *ngIf="isConnected" aria-live="polite">
      <ion-icon name="time-outline" aria-hidden="true"></ion-icon>
      <span>{{ callDuration }}</span>
    </div>
  </div>

  <!-- Incoming Call Notification -->
  <div class="incoming-call-notification" *ngIf="hasIncomingCall && !isConnected && !isConnecting" aria-live="assertive">
    <div class="wave-container">
      <div class="wave wave1"></div>
      <div class="wave wave2"></div>
      <div class="wave wave3"></div>
      <div class="wave wave4"></div>
      <div class="wave wave5"></div>
    </div>
    <p class="incoming-call-text">Incoming call from {{ clientName }}</p>
    <div class="call-controls incoming-controls">
      <ion-button fill="solid" 
                  color="success" 
                  (click)="acceptCall()"
                  aria-label="Accept incoming call">
        <ion-icon name="call-outline" slot="start" aria-hidden="true"></ion-icon>
        Accept
      </ion-button>
      <ion-button fill="solid" 
                  color="danger" 
                  (click)="rejectCall()"
                  aria-label="Reject incoming call">
        <ion-icon name="close-outline" slot="start" aria-hidden="true"></ion-icon>
        Reject
      </ion-button>
    </div>
  </div>

  <!-- Audio Visualizer (for audio-only calls) -->
  <div class="audio-visualizer" *ngIf="!showVideoElements && isConnected" aria-live="polite">
    <div class="wave-container">
      <div class="wave wave1" [class.active]="!isMuted"></div>
      <div class="wave wave2" [class.active]="!isMuted"></div>
      <div class="wave wave3" [class.active]="!isMuted"></div>
      <div class="wave wave4" [class.active]="!isMuted"></div>
      <div class="wave wave5" [class.active]="!isMuted"></div>
    </div>
    <p class="audio-status">Audio Call in Progress</p>
  </div>

  <!-- Video Container -->
  <div class="video-container" [class.hidden]="!showVideoElements">
    <!-- Remote Video -->
    <div class="video-wrapper">
      <video #remoteVideo 
             class="remote-video"
             autoplay
             playsinline
             aria-label="Client video stream">
      </video>
      <span class="video-label">{{ clientName }}</span>
    </div>
    
    <!-- Local Video (Picture-in-Picture) -->
    <div class="video-wrapper local-video-wrapper">
      <video #localVideo 
             class="local-video"
             autoplay
             playsinline
             muted
             aria-label="Your video stream">
      </video>
      <span class="video-label">You</span>
    </div>
  </div>

  <!-- Audio Elements (hidden but required for WebRTC) -->
  <audio #localAudio autoplay muted aria-hidden="true"></audio>
  <audio #remoteAudio autoplay aria-hidden="true"></audio>

  <!-- Call Controls -->
  <div class="call-controls" *ngIf="isConnected">
    <!-- Audio Control -->
    <ion-button fill="solid" 
                [color]="isAudioEnabled ? 'medium' : 'danger'"
                (click)="toggleAudio()"
                class="control-btn"
                [attr.aria-label]="isAudioEnabled ? 'Mute microphone' : 'Unmute microphone'">
      <ion-icon [name]="isAudioEnabled ? 'mic' : 'mic-off'" aria-hidden="true"></ion-icon>
    </ion-button>

    <!-- Video Control -->
    <ion-button fill="solid" 
                [color]="isVideoEnabled ? 'medium' : 'dark'"
                (click)="toggleVideo()"
                class="control-btn"
                [attr.aria-label]="isVideoEnabled ? 'Turn off camera' : 'Turn on camera'">
      <ion-icon [name]="isVideoEnabled ? 'videocam' : 'videocam-off'" aria-hidden="true"></ion-icon>
    </ion-button>

    <!-- Switch to Video Call (only show in audio mode) -->
    <ion-button fill="solid" 
                color="primary"
                (click)="switchToVideoCall()"
                class="control-btn"
                *ngIf="!isVideoEnabled"
                aria-label="Switch to video call">
      <ion-icon name="videocam" aria-hidden="true"></ion-icon>
    </ion-button>

    <!-- End Call -->
    <ion-button fill="solid" 
                color="danger" 
                (click)="endCall()"
                class="control-btn end-call-btn"
                aria-label="End call">
      <ion-icon name="call" class="end-call-icon" aria-hidden="true"></ion-icon>
    </ion-button>
  </div>

  <!-- Connection Status -->
  <div class="connection-status" *ngIf="isConnecting && !hasIncomingCall" aria-live="assertive">
    <ion-spinner name="crescent" aria-hidden="true"></ion-spinner>
    <p>{{ callStateText }}</p>
  </div>
</ion-content>